<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Update Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0284c7; }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .project-card {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üîÑ Portfolio Update Test</h1>
    
    <div class="section">
        <h2>Test Portfolio Sync</h2>
        <p>This tool tests if projects updated in the admin panel appear correctly in the portfolio.</p>
        
        <button onclick="testSupabaseConnection()">1. Test Supabase Connection</button>
        <button onclick="loadFromMetadataBucket()">2. Load from Metadata Bucket</button>
        <button onclick="loadFromLocalStorage()">3. Load from LocalStorage</button>
        <button onclick="compareData()">4. Compare Data Sources</button>
        <button onclick="forcePortfolioRefresh()">5. Force Portfolio Refresh</button>
    </div>
    
    <div class="section">
        <h2>Projects from Metadata Bucket</h2>
        <div id="metadataProjects" class="project-grid">
            <p class="text-gray-400">Click "Load from Metadata Bucket" to see projects</p>
        </div>
    </div>
    
    <div class="section">
        <h2>Projects from LocalStorage</h2>
        <div id="localStorageProjects" class="project-grid">
            <p class="text-gray-400">Click "Load from LocalStorage" to see projects</p>
        </div>
    </div>
    
    <div class="section">
        <h2>Debug Log</h2>
        <div id="log" class="log">Ready to test portfolio sync...\n</div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        let testSupabase = null;
        let metadataProjects = [];
        let localProjects = [];
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
        }
        
        async function testSupabaseConnection() {
            try {
                log('üîß Testing Supabase connection...');
                
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library not loaded');
                }
                
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('SUPABASE_CONFIG not loaded');
                }
                
                if (initializeSupabase()) {
                    testSupabase = configSupabase;
                    log('‚úÖ Supabase initialized successfully', 'success');
                } else {
                    throw new Error('Failed to initialize Supabase');
                }
                
                // Test bucket access
                const { data: buckets, error } = await testSupabase.storage.listBuckets();
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Found ${buckets.length} buckets`, 'success');
                
                const portfolioBucket = buckets.find(b => b.name === SUPABASE_CONFIG.bucket);
                const metadataBucket = buckets.find(b => b.name === SUPABASE_CONFIG.metadataBucket);
                
                if (portfolioBucket) {
                    log(`‚úÖ Portfolio bucket found: ${SUPABASE_CONFIG.bucket}`, 'success');
                } else {
                    log(`‚ùå Portfolio bucket missing: ${SUPABASE_CONFIG.bucket}`, 'error');
                }
                
                if (metadataBucket) {
                    log(`‚úÖ Metadata bucket found: ${SUPABASE_CONFIG.metadataBucket}`, 'success');
                } else {
                    log(`‚ùå Metadata bucket missing: ${SUPABASE_CONFIG.metadataBucket}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Supabase connection failed: ${error.message}`, 'error');
            }
        }
        
        async function loadFromMetadataBucket() {
            try {
                log('‚òÅÔ∏è Loading projects from metadata bucket...');
                
                if (!testSupabase) {
                    log('‚ùå Supabase not initialized. Run connection test first.', 'error');
                    return;
                }
                
                const result = await getProjects();
                
                if (result.success) {
                    metadataProjects = result.data;
                    log(`‚úÖ Loaded ${metadataProjects.length} projects from metadata bucket`, 'success');
                    
                    displayProjects('metadataProjects', metadataProjects);
                } else {
                    log(`‚ùå Failed to load from metadata bucket: ${result.error}`, 'error');
                    metadataProjects = [];
                }
                
            } catch (error) {
                log(`‚ùå Error loading from metadata bucket: ${error.message}`, 'error');
            }
        }
        
        function loadFromLocalStorage() {
            try {
                log('üì¶ Loading projects from localStorage...');
                
                const stored = localStorage.getItem('projects');
                if (stored) {
                    localProjects = JSON.parse(stored);
                    log(`‚úÖ Loaded ${localProjects.length} projects from localStorage`, 'success');
                } else {
                    localProjects = [];
                    log('üì¶ No projects found in localStorage', 'warning');
                }
                
                displayProjects('localStorageProjects', localProjects);
                
            } catch (error) {
                log(`‚ùå Error loading from localStorage: ${error.message}`, 'error');
            }
        }
        
        function displayProjects(containerId, projects) {
            const container = document.getElementById(containerId);
            
            if (projects.length === 0) {
                container.innerHTML = '<p class="text-gray-400">No projects found</p>';
                return;
            }
            
            container.innerHTML = projects.map(project => `
                <div class="project-card">
                    <h3 style="color: #0ea5e9; margin: 0 0 10px 0;">${project.title}</h3>
                    <p><strong>Key:</strong> ${project.key}</p>
                    <p><strong>Category:</strong> ${project.category}</p>
                    <p><strong>Count:</strong> ${project.count || 0} files</p>
                    <p><strong>Created:</strong> ${new Date(project.created_at).toLocaleString()}</p>
                    ${project.updated_at ? `<p><strong>Updated:</strong> ${new Date(project.updated_at).toLocaleString()}</p>` : ''}
                    ${project.thumbnail_url ? `<p><strong>Thumbnail:</strong> <a href="${project.thumbnail_url}" target="_blank" style="color: #0ea5e9;">View</a></p>` : ''}
                </div>
            `).join('');
        }
        
        function compareData() {
            log('üîç Comparing data sources...');
            
            if (metadataProjects.length === 0 && localProjects.length === 0) {
                log('‚ùå No data loaded. Load from both sources first.', 'error');
                return;
            }
            
            log(`üìä Metadata bucket: ${metadataProjects.length} projects`);
            log(`üìä LocalStorage: ${localProjects.length} projects`);
            
            // Check for differences
            const metadataKeys = metadataProjects.map(p => p.key);
            const localKeys = localProjects.map(p => p.key);
            
            const onlyInMetadata = metadataKeys.filter(key => !localKeys.includes(key));
            const onlyInLocal = localKeys.filter(key => !metadataKeys.includes(key));
            
            if (onlyInMetadata.length > 0) {
                log(`‚ö†Ô∏è Projects only in metadata bucket: ${onlyInMetadata.join(', ')}`, 'warning');
            }
            
            if (onlyInLocal.length > 0) {
                log(`‚ö†Ô∏è Projects only in localStorage: ${onlyInLocal.join(', ')}`, 'warning');
            }
            
            // Check for update differences
            metadataProjects.forEach(metaProject => {
                const localProject = localProjects.find(p => p.key === metaProject.key);
                if (localProject) {
                    if (metaProject.updated_at !== localProject.updated_at) {
                        log(`üîÑ Update time mismatch for ${metaProject.key}:`, 'warning');
                        log(`   Metadata: ${metaProject.updated_at}`);
                        log(`   Local: ${localProject.updated_at}`);
                    }
                    
                    if (metaProject.count !== localProject.count) {
                        log(`üìä File count mismatch for ${metaProject.key}:`, 'warning');
                        log(`   Metadata: ${metaProject.count || 0}`);
                        log(`   Local: ${localProject.count || 0}`);
                    }
                }
            });
            
            if (onlyInMetadata.length === 0 && onlyInLocal.length === 0) {
                log('‚úÖ Data sources are in sync', 'success');
            }
        }
        
        function forcePortfolioRefresh() {
            log('üîÑ Opening portfolio page with forced refresh...');
            
            // Open portfolio in new tab with cache-busting parameter
            const portfolioUrl = `index.html?refresh=${Date.now()}`;
            window.open(portfolioUrl, '_blank');
            
            log('‚úÖ Portfolio page opened. Check if projects appear correctly.', 'success');
        }
        
        // Auto-load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Portfolio update test loaded');
            
            // Auto-load localStorage data
            setTimeout(() => {
                loadFromLocalStorage();
            }, 500);
        });
    </script>
</body>
</html>
</content>
</invoke>