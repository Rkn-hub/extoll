<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Metadata Diagnosis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 5px solid;
        }
        .success { background: #1a3a1a; border-color: #0f0; }
        .error { background: #3a1a1a; border-color: #f00; }
        .warning { background: #3a3a1a; border-color: #ff0; }
        .info { background: #1a1a3a; border-color: #00f; }
        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
        }
        button:hover { background: #0284c7; }
        .code {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Quick Metadata Diagnosis</h1>
    
    <button onclick="runDiagnosis()">ğŸš€ Run Full Diagnosis</button>
    
    <div id="results"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        async function runDiagnosis() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">ğŸ”„ Running diagnosis...</div>';
            
            const checks = [];
            
            // Check 1: Supabase Library
            if (typeof window.supabase !== 'undefined') {
                checks.push({ name: 'Supabase Library', status: 'success', message: 'Supabase library loaded successfully' });
            } else {
                checks.push({ name: 'Supabase Library', status: 'error', message: 'Supabase library not loaded' });
            }
            
            // Check 2: Config File
            if (typeof SUPABASE_CONFIG !== 'undefined') {
                checks.push({ 
                    name: 'Config File', 
                    status: 'success', 
                    message: `Config loaded - URL: ${SUPABASE_CONFIG.url.substring(0, 30)}...` 
                });
            } else {
                checks.push({ name: 'Config File', status: 'error', message: 'supabase-config.js not loaded properly' });
            }
            
            // Check 3: Initialize Client
            let client = null;
            try {
                if (initializeSupabase()) {
                    client = configSupabase;
                    checks.push({ name: 'Client Initialization', status: 'success', message: 'Supabase client initialized' });
                } else {
                    checks.push({ name: 'Client Initialization', status: 'error', message: 'Failed to initialize client' });
                }
            } catch (error) {
                checks.push({ name: 'Client Initialization', status: 'error', message: error.message });
            }
            
            // Check 4: Connection Test
            if (client) {
                try {
                    const { data: buckets, error } = await client.storage.listBuckets();
                    if (error) throw error;
                    
                    const portfolioBucket = buckets.find(b => b.name === SUPABASE_CONFIG.bucket);
                    const metadataBucket = buckets.find(b => b.name === SUPABASE_CONFIG.metadataBucket);
                    
                    if (portfolioBucket && metadataBucket) {
                        checks.push({ 
                            name: 'Buckets Check', 
                            status: 'success', 
                            message: `Both buckets found: ${SUPABASE_CONFIG.bucket} (${portfolioBucket.public ? 'PUBLIC' : 'PRIVATE'}), ${SUPABASE_CONFIG.metadataBucket} (${metadataBucket.public ? 'PUBLIC' : 'PRIVATE'})` 
                        });
                    } else {
                        const missing = [];
                        if (!portfolioBucket) missing.push(SUPABASE_CONFIG.bucket);
                        if (!metadataBucket) missing.push(SUPABASE_CONFIG.metadataBucket);
                        checks.push({ 
                            name: 'Buckets Check', 
                            status: 'error', 
                            message: `Missing buckets: ${missing.join(', ')}` 
                        });
                    }
                } catch (error) {
                    checks.push({ name: 'Connection Test', status: 'error', message: error.message });
                }
            }
            
            // Check 5: Authentication Test
            if (client) {
                try {
                    const authResult = await signInAdmin();
                    if (authResult.success) {
                        checks.push({ 
                            name: 'Authentication', 
                            status: 'success', 
                            message: `Admin authenticated: ${authResult.user.email}` 
                        });
                        
                        // Check 6: Metadata Bucket Access
                        try {
                            const bucketTest = await testMetadataBucketAccess();
                            if (bucketTest.success) {
                                checks.push({ 
                                    name: 'Metadata Bucket Access', 
                                    status: 'success', 
                                    message: 'Can access metadata bucket successfully' 
                                });
                            } else {
                                checks.push({ 
                                    name: 'Metadata Bucket Access', 
                                    status: 'error', 
                                    message: bucketTest.error 
                                });
                            }
                        } catch (error) {
                            checks.push({ 
                                name: 'Metadata Bucket Access', 
                                status: 'error', 
                                message: error.message 
                            });
                        }
                        
                    } else {
                        checks.push({ 
                            name: 'Authentication', 
                            status: 'error', 
                            message: authResult.error 
                        });
                    }
                } catch (error) {
                    checks.push({ name: 'Authentication', status: 'error', message: error.message });
                }
            }
            
            // Display results
            let html = '';
            let allGood = true;
            
            checks.forEach(check => {
                const statusClass = check.status;
                const icon = check.status === 'success' ? 'âœ…' : check.status === 'error' ? 'âŒ' : 'âš ï¸';
                html += `<div class="${statusClass}"><strong>${icon} ${check.name}:</strong> ${check.message}</div>`;
                if (check.status === 'error') allGood = false;
            });
            
            if (allGood) {
                html += '<div class="success"><strong>ğŸ‰ All checks passed!</strong> Your metadata bucket should be working correctly.</div>';
            } else {
                html += '<div class="error"><strong>ğŸš¨ Issues found!</strong> Please fix the errors above.</div>';
                html += '<div class="info"><strong>ğŸ’¡ Quick fixes:</strong><br>';
                html += '1. Create missing buckets in Supabase Dashboard â†’ Storage<br>';
                html += '2. Create admin user: Authentication â†’ Users â†’ Add user (admin@extoll.co / extoll2024)<br>';
                html += '3. Apply bucket policies from metadata-bucket-policies.sql<br>';
                html += '4. Make sure extoll-metadata bucket is set to PRIVATE</div>';
            }
            
            results.innerHTML = html;
        }
    </script>
</body>
</html>