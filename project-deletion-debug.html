<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Deletion Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0284c7; }
        button.danger {
            background: #dc2626;
        }
        button.danger:hover { background: #b91c1c; }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        input, select {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 5px;
            margin: 5px;
        }
        .file-list {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üóëÔ∏è Project Deletion Debug Tool</h1>
    
    <div class="section">
        <h2>Step 1: Select Project to Debug</h2>
        <select id="projectSelect" onchange="loadProjectInfo()">
            <option value="">Select a project...</option>
        </select>
        <button onclick="loadProjects()">Refresh Projects</button>
    </div>
    
    <div class="section">
        <h2>Step 2: Inspect Project Files</h2>
        <div id="projectInfo" style="display: none;">
            <h3>Project Details:</h3>
            <div id="projectDetails"></div>
            
            <h3>Files in Storage:</h3>
            <button onclick="listProjectFiles()">List Files</button>
            <button onclick="deepScanFiles()">Deep Scan</button>
            <div id="filesList" class="file-list"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>Step 3: Test Deletion</h2>
        <button onclick="testFileDeletion()" class="danger">Test File Deletion</button>
        <button onclick="forceDeleteAllFiles()" class="danger">Force Delete All Files</button>
        <button onclick="verifyDeletion()">Verify Deletion</button>
    </div>
    
    <div class="section">
        <h2>Debug Log</h2>
        <div id="log" class="log">Ready to debug project deletion...\n</div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        let testSupabase = null;
        let currentProject = null;
        let projectFiles = [];
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
        }
        
        async function initializeSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library not loaded');
                }
                
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('SUPABASE_CONFIG not loaded');
                }
                
                if (initializeSupabase()) {
                    testSupabase = configSupabase;
                    log('‚úÖ Supabase initialized successfully', 'success');
                    return true;
                } else {
                    throw new Error('Failed to initialize Supabase');
                }
            } catch (error) {
                log(`‚ùå Supabase initialization failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function loadProjects() {
            if (!testSupabase && !await initializeSupabase()) {
                return;
            }
            
            log('üì¶ Loading projects...');
            
            try {
                // Load from localStorage
                const localProjects = JSON.parse(localStorage.getItem('projects') || '[]');
                
                const projectSelect = document.getElementById('projectSelect');
                projectSelect.innerHTML = '<option value="">Select a project...</option>';
                
                localProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.key;
                    option.textContent = `${project.title} (${project.key})`;
                    option.dataset.project = JSON.stringify(project);
                    projectSelect.appendChild(option);
                });
                
                log(`‚úÖ Loaded ${localProjects.length} projects`, 'success');
                
            } catch (error) {
                log(`‚ùå Error loading projects: ${error.message}`, 'error');
            }
        }
        
        function loadProjectInfo() {
            const projectSelect = document.getElementById('projectSelect');
            const selectedOption = projectSelect.selectedOptions[0];
            
            if (!selectedOption || !selectedOption.value) {
                document.getElementById('projectInfo').style.display = 'none';
                currentProject = null;
                return;
            }
            
            currentProject = JSON.parse(selectedOption.dataset.project);
            
            document.getElementById('projectInfo').style.display = 'block';
            document.getElementById('projectDetails').innerHTML = `
                <p><strong>Title:</strong> ${currentProject.title}</p>
                <p><strong>Key:</strong> ${currentProject.key}</p>
                <p><strong>Category:</strong> ${currentProject.category}</p>
                <p><strong>Count:</strong> ${currentProject.count || 0}</p>
                <p><strong>Created:</strong> ${new Date(currentProject.created_at).toLocaleString()}</p>
            `;
            
            log(`üìã Selected project: ${currentProject.title} (${currentProject.key})`);
        }
        
        async function listProjectFiles() {
            if (!currentProject || !testSupabase) {
                log('‚ùå No project selected or Supabase not initialized', 'error');
                return;
            }
            
            log(`üîç Listing files for project: ${currentProject.key}`);
            
            try {
                const { data: files, error } = await testSupabase.storage
                    .from(SUPABASE_CONFIG.bucket)
                    .list(currentProject.key);
                
                if (error) {
                    log(`‚ùå Error listing files: ${error.message}`, 'error');
                    return;
                }
                
                projectFiles = files || [];
                
                const filesList = document.getElementById('filesList');
                
                if (projectFiles.length === 0) {
                    filesList.innerHTML = '<p>No files found in this project folder.</p>';
                    log('üìÅ No files found in project folder');
                } else {
                    filesList.innerHTML = `
                        <h4>Found ${projectFiles.length} files:</h4>
                        <ul>
                            ${projectFiles.map(file => `
                                <li>
                                    <strong>${file.name}</strong><br>
                                    Size: ${(file.metadata?.size || 0)} bytes<br>
                                    Created: ${new Date(file.created_at).toLocaleString()}
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    log(`‚úÖ Found ${projectFiles.length} files in project folder`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error listing project files: ${error.message}`, 'error');
            }
        }
        
        async function deepScanFiles() {
            if (!currentProject || !testSupabase) {
                log('‚ùå No project selected or Supabase not initialized', 'error');
                return;
            }
            
            log(`üîç Deep scanning files for project: ${currentProject.key}`);
            
            try {
                // Try different list parameters
                const scans = [
                    { limit: 1000, offset: 0 },
                    { limit: 100, offset: 0, sortBy: { column: 'name', order: 'asc' } },
                    { limit: 100, offset: 0, sortBy: { column: 'created_at', order: 'desc' } }
                ];
                
                let allFiles = new Set();
                
                for (let i = 0; i < scans.length; i++) {
                    const scanParams = scans[i];
                    log(`üîç Scan ${i + 1}: ${JSON.stringify(scanParams)}`);
                    
                    const { data: files, error } = await testSupabase.storage
                        .from(SUPABASE_CONFIG.bucket)
                        .list(currentProject.key, scanParams);
                    
                    if (error) {
                        log(`‚ùå Scan ${i + 1} error: ${error.message}`, 'error');
                    } else {
                        const fileCount = files ? files.length : 0;
                        log(`üìä Scan ${i + 1} found: ${fileCount} files`);
                        
                        if (files) {
                            files.forEach(file => allFiles.add(JSON.stringify(file)));
                        }
                    }
                }
                
                const uniqueFiles = Array.from(allFiles).map(f => JSON.parse(f));
                projectFiles = uniqueFiles;
                
                const filesList = document.getElementById('filesList');
                filesList.innerHTML = `
                    <h4>Deep Scan Results - ${uniqueFiles.length} unique files:</h4>
                    <ul>
                        ${uniqueFiles.map(file => `
                            <li>
                                <strong>${file.name}</strong><br>
                                Size: ${(file.metadata?.size || 0)} bytes<br>
                                Created: ${new Date(file.created_at).toLocaleString()}
                            </li>
                        `).join('')}
                    </ul>
                `;
                
                log(`‚úÖ Deep scan completed: ${uniqueFiles.length} unique files found`, 'success');
                
            } catch (error) {
                log(`‚ùå Deep scan error: ${error.message}`, 'error');
            }
        }
        
        async function testFileDeletion() {
            if (!currentProject || !testSupabase || projectFiles.length === 0) {
                log('‚ùå No project selected, Supabase not initialized, or no files to delete', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${projectFiles.length} files from ${currentProject.key}?`)) {
                return;
            }
            
            log(`üóëÔ∏è Testing deletion of ${projectFiles.length} files...`);
            
            try {
                const filesToDelete = projectFiles.map(file => `${currentProject.key}/${file.name}`);
                
                log(`üóëÔ∏è Files to delete: ${filesToDelete.join(', ')}`);
                
                const { data, error } = await testSupabase.storage
                    .from(SUPABASE_CONFIG.bucket)
                    .remove(filesToDelete);
                
                if (error) {
                    log(`‚ùå Deletion failed: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Deletion completed successfully`, 'success');
                    log(`üìä Deletion result: ${JSON.stringify(data)}`);
                    
                    // Verify deletion
                    setTimeout(() => {
                        verifyDeletion();
                    }, 1000);
                }
                
            } catch (error) {
                log(`‚ùå Deletion error: ${error.message}`, 'error');
            }
        }
        
        async function forceDeleteAllFiles() {
            if (!currentProject || !testSupabase) {
                log('‚ùå No project selected or Supabase not initialized', 'error');
                return;
            }
            
            if (!confirm(`FORCE DELETE: This will attempt to delete ALL files in ${currentProject.key} folder. Continue?`)) {
                return;
            }
            
            log(`üö® Force deleting all files in project: ${currentProject.key}`);
            
            try {
                // First, do a fresh scan
                await deepScanFiles();
                
                if (projectFiles.length === 0) {
                    log('üìÅ No files found to delete');
                    return;
                }
                
                // Delete in batches
                const batchSize = 10;
                for (let i = 0; i < projectFiles.length; i += batchSize) {
                    const batch = projectFiles.slice(i, i + batchSize);
                    const filesToDelete = batch.map(file => `${currentProject.key}/${file.name}`);
                    
                    log(`üóëÔ∏è Deleting batch ${Math.floor(i/batchSize) + 1}: ${filesToDelete.length} files`);
                    
                    const { data, error } = await testSupabase.storage
                        .from(SUPABASE_CONFIG.bucket)
                        .remove(filesToDelete);
                    
                    if (error) {
                        log(`‚ùå Batch deletion failed: ${error.message}`, 'error');
                    } else {
                        log(`‚úÖ Batch deleted successfully`);
                    }
                    
                    // Small delay between batches
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                log('üéâ Force deletion completed');
                
                // Verify deletion
                setTimeout(() => {
                    verifyDeletion();
                }, 2000);
                
            } catch (error) {
                log(`‚ùå Force deletion error: ${error.message}`, 'error');
            }
        }
        
        async function verifyDeletion() {
            if (!currentProject || !testSupabase) {
                log('‚ùå No project selected or Supabase not initialized', 'error');
                return;
            }
            
            log(`üîç Verifying deletion for project: ${currentProject.key}`);
            
            try {
                const { data: files, error } = await testSupabase.storage
                    .from(SUPABASE_CONFIG.bucket)
                    .list(currentProject.key);
                
                if (error) {
                    log(`‚ùå Verification error: ${error.message}`, 'error');
                    return;
                }
                
                const remainingFiles = files || [];
                
                if (remainingFiles.length === 0) {
                    log('‚úÖ Verification successful: No files remain in project folder', 'success');
                    document.getElementById('filesList').innerHTML = '<p style="color: #0f0;">‚úÖ Project folder is empty</p>';
                } else {
                    log(`‚ö†Ô∏è Verification failed: ${remainingFiles.length} files still remain`, 'warning');
                    document.getElementById('filesList').innerHTML = `
                        <h4 style="color: #ff0;">‚ö†Ô∏è ${remainingFiles.length} files still remain:</h4>
                        <ul>
                            ${remainingFiles.map(file => `
                                <li style="color: #ff0;">
                                    <strong>${file.name}</strong><br>
                                    Size: ${(file.metadata?.size || 0)} bytes
                                </li>
                            `).join('')}
                        </ul>
                    `;
                }
                
            } catch (error) {
                log(`‚ùå Verification error: ${error.message}`, 'error');
            }
        }
        
        // Auto-load projects on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Project deletion debug tool loaded');
            loadProjects();
        });
    </script>
</body>
</html>
</content>
</invoke>