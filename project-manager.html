<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes"
        name="viewport" />
    <title>Project Manager - Extoll.Co</title>
    <link rel="icon" type="image/png" href="extoll.png">
    <link rel="apple-touch-icon" href="extoll.png">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
    // Theme logic moved to head
  </script>
    <style>
        html {
            font-size: 18px;
        }
        body {
            background: linear-gradient(135deg, #0A0A0D 0%, #1a1a2e 50%, #16213e 100%);
            color: #e5e7eb;
            font-family: 'Space Grotesk', sans-serif;
            min-height: 100vh;
            zoom: 1.1;
            transform-origin: top left;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(51, 65, 85, 0.4);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.25);
            font-size: 16px;
        }
        .btn-secondary {
            background: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
            padding: 12px 24px;
            border: 2px solid rgba(14, 165, 233, 0.4);
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 14px;
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .form-input {
            background: rgba(15, 23, 42, 0.9) !important;
            border: 2px solid rgba(51, 65, 85, 0.6) !important;
            color: #e2e8f0 !important;
            padding: 16px 20px !important;
            border-radius: 12px !important;
            width: 100% !important;
            transition: all 0.3s ease !important;
            backdrop-filter: blur(10px) !important;
            font-size: 16px !important;
            text-align: left !important;
            line-height: 1.5 !important;
        }
        .form-textarea {
            background: rgba(15, 23, 42, 0.9) !important;
            border: 2px solid rgba(51, 65, 85, 0.6) !important;
            color: #e2e8f0 !important;
            padding: 16px 20px !important;
            border-radius: 12px !important;
            width: 100% !important;
            min-height: 120px !important;
            resize: vertical !important;
            transition: all 0.3s ease !important;
            backdrop-filter: blur(10px) !important;
            font-family: inherit !important;
            font-size: 16px !important;
            line-height: 1.6 !important;
            text-align: left !important;
            vertical-align: top !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            white-space: pre-wrap !important;
        }
        .upload-area {
            border: 3px dashed rgba(14, 165, 233, 0.4);
            background: rgba(14, 165, 233, 0.05);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .upload-area:hover {
            border-color: #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
            transform: translateY(-2px);
        }
        .upload-area.dragover {
            border-color: #0ea5e9;
            background: rgba(14, 165, 233, 0.2);
            transform: scale(1.02);
        }
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.4s ease;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        .notification.error {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .notification.warning {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        /* Cursor styles for all interactive elements */
        button,
        .cursor-pointer,
        .btn-primary,
        .btn-secondary,
        .upload-area,
        .file-item,
        .thumbnail-item,
        [onclick],
        input[type="submit"],
        input[type="file"],
        select,
        a[href] {
            cursor: pointer !important;
        }
        /* Ensure disabled buttons show not-allowed cursor */
        button:disabled,
        input:disabled,
        select:disabled {
            cursor: not-allowed !important;
        }
        /* Specific cursor for drag and drop areas */
        .upload-area.dragover {
            cursor: copy !important;
        }
        /* Text alignment and formatting improvements */
        .form-input:focus,
        .form-textarea:focus {
            border-color: rgba(14, 165, 233, 0.8) !important;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1) !important;
            outline: none !important;
        }
        /* Ensure proper text rendering */
        input,
        textarea,
        select {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        /* Fix any potential text overflow issues */
        .glass-card {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .file-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.6);
        }
        .file-item img,
        .file-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .file-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .file-item:hover .file-overlay {
            opacity: 1;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-black/50 backdrop-blur-md border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center gap-4">
                    <button onclick="goBack()" class="btn-secondary">â† Back to Admin</button>
                    <h1 class="text-2xl font-bold text-white">Project Manager</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span id="projectStatus" class="text-sm text-gray-400">Loading project...</span>
                    <button id="saveButton" onclick="saveProject()" class="btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Project Not Found -->
        <div id="projectNotFound" class="hidden text-center py-20">
            <div class="glass-card p-12 rounded-xl max-w-md mx-auto">
                <div class="text-6xl mb-6">âŒ</div>
                <h2 class="text-2xl font-bold text-white mb-4">Project Not Found</h2>
                <p class="text-gray-400 mb-6">The requested project could not be found.</p>
                <button onclick="goBack()" class="btn-primary">Back to Admin</button>
            </div>
        </div>
        <!-- Project Manager -->
        <div id="projectManager" class="hidden">
            <!-- Project Overview Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Project Overview Panel -->
                <div class="lg:col-span-1">
                    <div class="glass-card p-6 rounded-xl sticky top-8">
                        <h2 class="text-xl font-bold text-white mb-6">Project Overview</h2>
                        <!-- Project Thumbnail -->
                        <div id="overviewThumbnail" class="aspect-square bg-gray-800 rounded-lg mb-4 overflow-hidden">
                            <span class="flex items-center justify-center h-full text-gray-400 text-sm">No
                                thumbnail</span>
                        </div>
                        <!-- Project Details -->
                        <div class="space-y-4">
                            <div>
                                <h3 id="overviewTitle" class="text-lg font-semibold text-white mb-1">Untitled Project
                                </h3>
                                <p id="overviewCategory" class="text-sm text-blue-400 capitalize">Category</p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-gray-300 mb-2">Description</h4>
                                <div id="overviewDescription"
                                    class="text-sm text-gray-300 leading-relaxed break-words whitespace-pre-wrap">
                                    No description available
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                                <div>
                                    <h4 class="text-xs font-medium text-gray-400 mb-1">Files</h4>
                                    <p id="overviewCount" class="text-lg font-semibold text-white">0</p>
                                </div>
                                <div>
                                    <h4 class="text-xs font-medium text-gray-400 mb-1">Status</h4>
                                    <p class="text-sm text-green-400">Active</p>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xs font-medium text-gray-400 mb-2">Tags</h4>
                                <div id="overviewTags" class="flex flex-wrap gap-1">
                                    <span class="text-xs text-gray-500">No tags</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Project Edit Forms -->
                <div class="lg:col-span-2">
                    <!-- Project Info Section -->
                    <div class="glass-card p-8 rounded-xl mb-8">
                        <h2 class="text-2xl font-bold text-white mb-6">Project Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-lg font-medium text-gray-300 mb-3">Project Title</label>
                                <input type="text" id="projectTitle" class="form-input"
                                    placeholder="Enter project title">
                            </div>
                            <div>
                                <label class="block text-lg font-medium text-gray-300 mb-3">Project Key</label>
                                <input type="text" id="projectKey" class="form-input" placeholder="Auto-generated"
                                    readonly>
                            </div>
                            <div>
                                <label class="block text-lg font-medium text-gray-300 mb-3">Category</label>
                                <select id="projectCategory" class="form-input">
                                    <option value="graphics">Graphics Design</option>
                                    <option value="product">Product Design</option>
                                    <option value="ui">UI/UX Design</option>
                                    <option value="animation">2D Animation</option>
                                    <option value="video">Video Editing</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-lg font-medium text-gray-300 mb-3">File Count</label>
                                <input type="text" id="projectCount" class="form-input" readonly>
                            </div>
                        </div>
                        <div class="mt-6">
                            <label class="block text-lg font-medium text-gray-300 mb-3">Description</label>
                            <textarea id="projectDescription" class="form-textarea"
                                placeholder="Enter project description"
                                style="text-align: left; line-height: 1.6; word-wrap: break-word;"></textarea>
                        </div>
                        <div class="mt-6">
                            <label class="block text-lg font-medium text-gray-300 mb-3">Tags (comma separated)</label>
                            <input type="text" id="projectTags" class="form-input"
                                placeholder="e.g., wedding, portrait, outdoor">
                        </div>
                    </div>
                    <!-- Thumbnail Section -->
                    <div class="glass-card p-8 rounded-xl mb-8">
                        <h2 class="text-2xl font-bold text-white mb-6">Project Thumbnail</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-lg font-medium text-gray-300 mb-4">Current Thumbnail</h3>
                                <div id="currentThumbnail"
                                    class="aspect-square bg-gray-800 rounded-lg flex items-center justify-center">
                                    <span class="text-gray-400">No thumbnail set</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-300 mb-4">Upload New Thumbnail</h3>
                                <div class="upload-area" id="thumbnailUpload">
                                    <div class="text-center">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                            viewBox="0 0 48 48">
                                            <path
                                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="mt-2 text-gray-400">Click to upload or drag & drop</p>
                                        <p class="text-xs text-gray-500">JPG, PNG, WebP (Max 5MB)</p>
                                    </div>
                                    <input type="file" id="thumbnailInput" class="hidden" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Project Files Section -->
                    <div class="glass-card p-8 rounded-xl mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">Project Files</h2>
                            <div class="flex gap-4">
                                <select id="fileFilter" class="form-input" style="width: auto;"
                                    onchange="filterFiles()">
                                    <option value="all">All Files</option>
                                    <option value="images">Images Only</option>
                                    <option value="videos">Videos Only</option>
                                </select>
                                <button onclick="refreshFiles()" class="btn-secondary">Refresh</button>
                            </div>
                        </div>
                        <!-- Upload Areas -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <h3 class="text-lg font-medium text-gray-300 mb-4">Upload Images</h3>
                                <div class="upload-area" id="imageUpload">
                                    <div class="text-center">
                                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none"
                                            viewBox="0 0 48 48">
                                            <path
                                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="mt-2 text-sm text-gray-400">Upload Images</p>
                                        <p class="text-xs text-gray-500">Multiple files supported</p>
                                    </div>
                                    <input type="file" id="imageInput" class="hidden" accept="image/*" multiple>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-300 mb-4">Upload Videos</h3>
                                <div class="upload-area" id="videoUpload">
                                    <div class="text-center">
                                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none"
                                            viewBox="0 0 48 48">
                                            <path
                                                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2zM7 9h2v2H7V9z"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="mt-2 text-sm text-gray-400">Upload Videos</p>
                                        <p class="text-xs text-gray-500">Multiple files supported</p>
                                    </div>
                                    <input type="file" id="videoInput" class="hidden" accept="video/*" multiple>
                                </div>
                            </div>
                        </div>
                        <!-- Upload Progress -->
                        <div id="uploadProgress" class="hidden mb-6">
                            <h3 class="text-lg font-medium text-gray-300 mb-4">Upload Progress</h3>
                            <div id="uploadProgressList" class="space-y-2"></div>
                        </div>
                        <!-- Files Gallery -->
                        <div id="filesGallery" class="gallery-grid">
                            <div class="col-span-full text-center py-8 text-gray-400">
                                Loading project files...
                            </div>
                        </div>
                    </div>
                    <!-- Danger Zone -->
                    <div class="glass-card p-8 rounded-xl border-red-500/20">
                        <h2 class="text-2xl font-bold text-red-400 mb-6">Danger Zone</h2>
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-medium text-white mb-2">Delete Project</h3>
                                <p class="text-gray-400">This will permanently delete the project and all its files.</p>
                            </div>
                            <button onclick="deleteProject()" class="btn-danger">Delete Project</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        let currentProject = null;
        let projectFiles = [];
        let adminSupabase = null;
        // Get project ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        // Notification function
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            if (notification && notificationText) {
                notificationText.textContent = message;
                notification.className = 'notification ' + type;
                notification.classList.add('show');
                setTimeout(function () {
                    notification.classList.remove('show');
                }, 3000);
            }
        }
        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ðŸš€ Project Manager initializing...');
            if (!projectId) {
                showProjectNotFound();
                return;
            }
            // Check if this is a new project creation
            if (projectId === 'new') {
                console.log('ðŸ“ Creating new project...');
                setupNewProjectMode();
                return;
            }
            // Initialize Supabase
            if (typeof window.supabase !== 'undefined') {
                const initResult = initializeSupabase();
                if (initResult) {
                    adminSupabase = configSupabase;
                    console.log('âœ… Supabase initialized');
                }
            }
            loadProject(projectId);
            setupEventListeners();
        });
        function setupNewProjectMode() {
            console.log('ðŸ†• Setting up new project mode');
            // Initialize Supabase
            if (typeof window.supabase !== 'undefined') {
                const initResult = initializeSupabase();
                if (initResult) {
                    adminSupabase = configSupabase;
                    console.log('âœ… Supabase initialized');
                }
            }
            // Clear the form for new project
            currentProject = null;
            document.getElementById('projectTitle').value = '';
            document.getElementById('projectKey').value = '';
            document.getElementById('projectCategory').value = 'graphics';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectTags').value = '';
            // Update page title
            document.querySelector('h1').textContent = 'Create New Project';
            // Change button text
            const saveBtn = document.querySelector('.btn-primary');
            if (saveBtn) {
                saveBtn.textContent = 'Create Project';
            }
            // Show the project manager form
            showProjectManager();
            setupEventListeners();
            console.log('âœ… New project mode ready');
        }
        function showProjectNotFound() {
            document.getElementById('projectNotFound').classList.remove('hidden');
            document.getElementById('projectManager').classList.add('hidden');
        }
        function showProjectManager() {
            document.getElementById('projectNotFound').classList.add('hidden');
            document.getElementById('projectManager').classList.remove('hidden');
        }
        async function loadProject(projectId) {
            try {
                // Load from localStorage first
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                currentProject = projects.find(p => p.id === projectId);
                if (!currentProject) {
                    showProjectNotFound();
                    return;
                }
                console.log('âœ… Project loaded:', currentProject.title);
                populateProjectForm();
                showProjectManager();
                loadProjectFiles();
            } catch (error) {
                console.error('âŒ Error loading project:', error);
                showProjectNotFound();
            }
        }
        function populateProjectForm() {
            document.getElementById('projectTitle').value = currentProject.title || '';
            document.getElementById('projectKey').value = currentProject.key || '';
            document.getElementById('projectCategory').value = currentProject.category || 'photography';
            // Enhanced description handling with debugging
            const descriptionElement = document.getElementById('projectDescription');
            const description = currentProject.description || '';
            console.log('ðŸ“ Loading description:', description);
            console.log('ðŸ“ Description element:', descriptionElement);
            if (descriptionElement) {
                descriptionElement.value = description;
                console.log('ðŸ“ Set description value to:', descriptionElement.value);
                // Force update the textarea
                descriptionElement.dispatchEvent(new Event('input', { bubbles: true }));
            } else {
                console.error('âŒ Description textarea element not found!');
            }
            document.getElementById('projectTags').value = currentProject.tags ? currentProject.tags.join(', ') : '';
            document.getElementById('projectCount').value = currentProject.count || '0';
            // Update status
            document.getElementById('projectStatus').textContent = `Editing: ${currentProject.title}`;
            // Load thumbnail
            if (currentProject.thumbnail_url) {
                document.getElementById('currentThumbnail').innerHTML = `
            <img src="${currentProject.thumbnail_url}" alt="Thumbnail" class="w-full h-full object-cover rounded-lg">
        `;
            }
            // Update overview panel
            updateProjectOverview();
        }
        function updateProjectOverview() {
            if (!currentProject) return;
            // Update overview title
            document.getElementById('overviewTitle').textContent = currentProject.title || 'Untitled Project';
            // Update overview category
            document.getElementById('overviewCategory').textContent = currentProject.category || 'No category';
            // Update overview description with proper text alignment
            const overviewDesc = document.getElementById('overviewDescription');
            const description = currentProject.description || 'No description available';
            overviewDesc.textContent = description;
            // Update overview count
            document.getElementById('overviewCount').textContent = currentProject.count || '0';
            // Update overview thumbnail
            const overviewThumb = document.getElementById('overviewThumbnail');
            if (currentProject.thumbnail_url) {
                overviewThumb.innerHTML = `
            <img src="${currentProject.thumbnail_url}" alt="Thumbnail" class="w-full h-full object-cover rounded-lg">
        `;
            } else {
                overviewThumb.innerHTML = `
            <span class="flex items-center justify-center h-full text-gray-400 text-sm">No thumbnail</span>
        `;
            }
            // Update overview tags
            const overviewTags = document.getElementById('overviewTags');
            if (currentProject.tags && currentProject.tags.length > 0) {
                overviewTags.innerHTML = currentProject.tags.map(tag =>
                    `<span class="px-2 py-1 bg-blue-500/20 text-blue-300 text-xs rounded-full">${tag.trim()}</span>`
                ).join('');
            } else {
                overviewTags.innerHTML = '<span class="text-xs text-gray-500">No tags</span>';
            }
        }
        async function loadProjectFiles() {
            if (!adminSupabase || !currentProject.key) {
                console.log('âŒ Cannot load files: missing Supabase or project key');
                return;
            }
            console.log('ðŸ” Loading files for project:', currentProject.key);
            try {
                const { data: files, error } = await adminSupabase.storage
                    .from(SUPABASE_CONFIG.bucket)
                    .list(currentProject.key, {
                        limit: 1000,
                        sortBy: { column: 'created_at', order: 'desc' }
                    });
                if (error) {
                    console.error('âŒ Error loading files:', error);
                    return;
                }
                if (!files || files.length === 0) {
                    projectFiles = [];
                    displayFiles();
                    return;
                }
                projectFiles = files.map(file => {
                    const filePath = `${currentProject.key}/${file.name}`;
                    const { data: urlData } = adminSupabase.storage
                        .from(SUPABASE_CONFIG.bucket)
                        .getPublicUrl(filePath);
                    return {
                        name: file.name,
                        path: filePath,
                        url: urlData.publicUrl,
                        size: file.metadata?.size || 0,
                        created_at: file.created_at,
                        type: getFileType(file.name),
                        isThumbnail: file.name.startsWith('thumb-')
                    };
                }).filter(file => {
                    const fileName = file.name.toLowerCase();
                    // Filter out thumbnail files, logo files, and banner files
                    return !file.isThumbnail &&
                        !fileName.startsWith('logo') &&
                        !fileName.startsWith('banner') &&
                        !fileName.includes('/logo/') &&
                        !fileName.includes('/banner/') &&
                        fileName !== 'logo.png' &&
                        fileName !== 'banner.jpg' &&
                        fileName !== 'banner.png';
                }); // Filter out thumbnail, logo, and banner files from gallery
                console.log('âœ… Loaded', projectFiles.length, 'files');
                displayFiles();
                // Update count in both form and overview
                document.getElementById('projectCount').value = projectFiles.length;
                if (currentProject) {
                    currentProject.count = projectFiles.length;
                    updateProjectOverview();
                }
            } catch (error) {
                console.error('âŒ Error loading project files:', error);
            }
        }
        function displayFiles() {
            const gallery = document.getElementById('filesGallery');
            const filter = document.getElementById('fileFilter').value;
            let filteredFiles = projectFiles;
            if (filter === 'images') {
                filteredFiles = projectFiles.filter(f => f.type === 'image');
            } else if (filter === 'videos') {
                filteredFiles = projectFiles.filter(f => f.type === 'video');
            }
            if (filteredFiles.length === 0) {
                gallery.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No files found. Upload some files above.</div>';
                return;
            }
            gallery.innerHTML = filteredFiles.map(file => `
        <div class="file-item">
            ${file.type === 'image' ?
                    `<img src="${file.url}" alt="${file.name}" loading="lazy">` :
                    file.type === 'video' ?
                        `<video src="${file.url}" preload="metadata"></video>` :
                        `<div class="w-full h-full flex items-center justify-center bg-gray-700">
                    <span class="text-4xl">ðŸ“„</span>
                </div>`
                }
            <div class="file-overlay">
                <button onclick="deleteFile('${file.path}')" class="btn-danger text-sm">Delete</button>
            </div>
        </div>
    `).join('');
        }
        function getFileType(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(extension)) {
                return 'image';
            } else if (['mp4', 'webm', 'mov', 'avi', 'mkv'].includes(extension)) {
                return 'video';
            }
            return 'other';
        }
        function setupEventListeners() {
            // Thumbnail upload
            const thumbnailArea = document.getElementById('thumbnailUpload');
            const thumbnailInput = document.getElementById('thumbnailInput');
            thumbnailArea.addEventListener('click', () => thumbnailInput.click());
            thumbnailInput.addEventListener('change', handleThumbnailUpload);
            // Image upload
            const imageArea = document.getElementById('imageUpload');
            const imageInput = document.getElementById('imageInput');
            imageArea.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleImageUpload);
            // Video upload
            const videoArea = document.getElementById('videoUpload');
            const videoInput = document.getElementById('videoInput');
            videoArea.addEventListener('click', () => videoInput.click());
            videoInput.addEventListener('change', handleVideoUpload);
            // Auto-generate project key from title
            document.getElementById('projectTitle').addEventListener('input', function (e) {
                const key = e.target.value.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim();
                document.getElementById('projectKey').value = key;
                // Update overview in real-time
                if (currentProject) {
                    currentProject.title = e.target.value;
                    updateProjectOverview();
                }
            });
            // Update overview when category changes
            document.getElementById('projectCategory').addEventListener('change', function (e) {
                if (currentProject) {
                    currentProject.category = e.target.value;
                    updateProjectOverview();
                }
            });
            // Update overview when tags change
            document.getElementById('projectTags').addEventListener('input', function (e) {
                if (currentProject) {
                    currentProject.tags = e.target.value.split(',').map(tag => tag.trim()).filter(tag => tag);
                    updateProjectOverview();
                }
            });
            // Auto-save description changes
            let descriptionSaveTimeout;
            document.getElementById('projectDescription').addEventListener('input', function (e) {
                console.log('ðŸ“ Description changed:', e.target.value);
                // Update overview in real-time
                if (currentProject) {
                    currentProject.description = e.target.value;
                    updateProjectOverview();
                }
                // Clear previous timeout
                if (descriptionSaveTimeout) {
                    clearTimeout(descriptionSaveTimeout);
                }
                // Show that changes are pending
                const saveButton = document.getElementById('saveButton');
                if (saveButton && saveButton.textContent === 'Save Changes') {
                    saveButton.textContent = 'Unsaved Changes';
                    saveButton.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                }
                // Auto-save after 2 seconds of no typing
                descriptionSaveTimeout = setTimeout(() => {
                    console.log('ðŸ’¾ Auto-saving description...');
                    if (currentProject) {
                        currentProject.description = e.target.value;
                        saveProjectSilently(); // Use silent save for auto-save
                    }
                }, 2000);
            });
            // Also save on blur (when user clicks away)
            document.getElementById('projectDescription').addEventListener('blur', function (e) {
                console.log('ðŸ“ Description blur event, saving...');
                if (currentProject) {
                    currentProject.description = e.target.value;
                    saveProjectSilently(); // Use silent save for blur
                }
            });
        }
        async function handleThumbnailUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            // Check if project exists, if not, try to save it first
            if (!currentProject) {
                const title = document.getElementById('projectTitle').value;
                if (!title) {
                    showNotification('Please enter a project title first', 'warning');
                    e.target.value = ''; // Clear the file input
                    return;
                }
                // Auto-save the project first (without redirect)
                showNotification('Saving project before upload...', 'warning');
                const saved = await saveProject(false);
                if (!saved || !currentProject) {
                    showNotification('Failed to save project. Please try again.', 'error');
                    e.target.value = ''; // Clear the file input
                    return;
                }
            }
            console.log('ðŸ“· Uploading thumbnail:', file.name);
            uploadFile(file, 'thumb-' + Date.now() + '.' + file.name.split('.').pop(), true);
        }
        async function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            // Check if project exists, if not, try to save it first
            if (!currentProject) {
                const title = document.getElementById('projectTitle').value;
                if (!title) {
                    showNotification('Please enter a project title first', 'warning');
                    e.target.value = ''; // Clear the file input
                    return;
                }
                // Auto-save the project first (without redirect)
                showNotification('Saving project before upload...', 'warning');
                const saved = await saveProject(false);
                if (!saved || !currentProject) {
                    showNotification('Failed to save project. Please try again.', 'error');
                    e.target.value = ''; // Clear the file input
                    return;
                }
            }
            console.log('ðŸ“· Uploading', files.length, 'images');
            files.forEach((file, index) => {
                const fileName = 'img-' + Date.now() + '-' + index + '.' + file.name.split('.').pop();
                uploadFile(file, fileName);
            });
        }
        async function handleVideoUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            // Check if project exists, if not, try to save it first
            if (!currentProject) {
                const title = document.getElementById('projectTitle').value;
                if (!title) {
                    showNotification('Please enter a project title first', 'warning');
                    e.target.value = ''; // Clear the file input
                    return;
                }
                // Auto-save the project first (without redirect)
                showNotification('Saving project before upload...', 'warning');
                const saved = await saveProject(false);
                if (!saved || !currentProject) {
                    showNotification('Failed to save project. Please try again.', 'error');
                    e.target.value = ''; // Clear the file input
                    return;
                }
            }
            console.log('ðŸŽ¥ Uploading', files.length, 'videos');
            files.forEach((file, index) => {
                const fileName = 'vid-' + Date.now() + '-' + index + '.' + file.name.split('.').pop();
                uploadFile(file, fileName);
            });
        }
        async function uploadFile(file, fileName, isThumbnail = false) {
            if (!adminSupabase || !currentProject || !currentProject.key) {
                showNotification('Please save the project first before uploading files', 'error');
                return;
            }
            const filePath = currentProject.key + '/' + fileName;
            // Show progress
            const progressSection = document.getElementById('uploadProgress');
            const progressList = document.getElementById('uploadProgressList');
            progressSection.classList.remove('hidden');
            const progressItem = document.createElement('div');
            progressItem.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg';
            progressItem.innerHTML = `
        <span class="text-white">${file.name}</span>
        <span class="text-gray-400">Uploading...</span>
    `;
            progressList.appendChild(progressItem);
            try {
                const { data, error } = await adminSupabase.storage
                    .from(SUPABASE_CONFIG.bucket)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true
                    });
                if (error) throw error;
                progressItem.innerHTML = `
            <span class="text-white">${file.name}</span>
            <span class="text-green-400">âœ“ Uploaded</span>
        `;
                if (isThumbnail) {
                    const { data: urlData } = adminSupabase.storage
                        .from(SUPABASE_CONFIG.bucket)
                        .getPublicUrl(filePath);
                    currentProject.thumbnail_url = urlData.publicUrl;
                    document.getElementById('currentThumbnail').innerHTML = `
                <img src="${urlData.publicUrl}" alt="Thumbnail" class="w-full h-full object-cover rounded-lg">
            `;
                    // Update overview thumbnail
                    updateProjectOverview();
                }
                showNotification('File uploaded successfully!', 'success');
                // Refresh files
                setTimeout(() => {
                    loadProjectFiles();
                }, 1000);
            } catch (error) {
                console.error('âŒ Upload error:', error);
                progressItem.innerHTML = `
            <span class="text-white">${file.name}</span>
            <span class="text-red-400">Failed: ${error.message}</span>
        `;
                showNotification('Upload failed: ' + error.message, 'error');
            }
        }
        async function deleteFile(filePath) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            try {
                const { error } = await adminSupabase.storage
                    .from(SUPABASE_CONFIG.bucket)
                    .remove([filePath]);
                if (error) throw error;
                showNotification('File deleted successfully', 'success');
                loadProjectFiles();
            } catch (error) {
                console.error('âŒ Delete error:', error);
                showNotification('Delete failed: ' + error.message, 'error');
            }
        }
        function filterFiles() {
            displayFiles();
        }
        function refreshFiles() {
            loadProjectFiles();
        }
        // Update save button state
        function updateSaveButton(state) {
            const saveButton = document.getElementById('saveButton');
            if (!saveButton) return;
            switch (state) {
                case 'saving':
                    saveButton.textContent = 'Saving...';
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.7';
                    break;
                case 'saved':
                    saveButton.textContent = 'âœ“ Saved';
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    // Reset to normal after 3 seconds
                    setTimeout(() => {
                        updateSaveButton('normal');
                    }, 3000);
                    break;
                case 'error':
                    saveButton.textContent = 'âœ— Error';
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
                    // Reset to normal after 3 seconds
                    setTimeout(() => {
                        updateSaveButton('normal');
                    }, 3000);
                    break;
                case 'normal':
                default:
                    saveButton.textContent = 'Save Changes';
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.background = 'linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%)';
                    break;
            }
        }
        async function saveProject(shouldRedirect = true) {
            // Update button to saving state
            updateSaveButton('saving');
            // Get form data
            const title = document.getElementById('projectTitle').value;
            const key = document.getElementById('projectKey').value;
            const category = document.getElementById('projectCategory').value;
            const description = document.getElementById('projectDescription').value;
            const tags = document.getElementById('projectTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const count = parseInt(document.getElementById('projectCount').value) || 0;
            // Validate required fields
            if (!title || !key) {
                showNotification('Please enter project title', 'error');
                updateSaveButton('error');
                return false;
            }
            // Check if this is a new project
            const isNewProject = !currentProject;
            if (isNewProject) {
                // Create new project object
                currentProject = {
                    id: Date.now().toString(),
                    title: title,
                    key: key,
                    category: category,
                    description: description,
                    tags: tags,
                    count: count,
                    thumbnail_url: null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                console.log('ðŸ†• Creating new project:', currentProject);
            } else {
                // Update existing project
                currentProject.title = title;
                currentProject.key = key;
                currentProject.category = category;
                currentProject.description = description;
                currentProject.tags = tags;
                currentProject.count = count;
                currentProject.updated_at = new Date().toISOString();
                console.log('ðŸ’¾ Updating existing project:', currentProject);
            }
            try {
                // Save to localStorage
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                if (isNewProject) {
                    projects.push(currentProject);
                    console.log('âœ… Added to localStorage');
                } else {
                    const projectIndex = projects.findIndex(p => p.id === currentProject.id);
                    if (projectIndex !== -1) {
                        projects[projectIndex] = currentProject;
                        console.log('âœ… Updated in localStorage');
                    }
                }
                localStorage.setItem('projects', JSON.stringify(projects));
                // Save to Supabase database table
                if (adminSupabase) {
                    try {
                        if (isNewProject) {
                            const { data: insertData, error: insertError } = await adminSupabase
                                .from('projects')
                                .insert([{
                                    title: currentProject.title,
                                    key: currentProject.key,
                                    category: currentProject.category,
                                    description: currentProject.description,
                                    count: currentProject.count || 1,
                                    thumbnail_url: currentProject.thumbnail_url || null,
                                    created_at: currentProject.created_at,
                                    updated_at: currentProject.updated_at
                                }])
                                .select()
                                .single();
                            if (insertError) {
                                console.error('âŒ Database insert failed:', insertError.message);
                            } else {
                                console.log('âœ… Project inserted into database:', insertData);
                                // Update the project ID with the database ID
                                if (insertData && insertData.id) {
                                    currentProject.id = insertData.id;
                                }
                            }
                        } else {
                            const { data: dbData, error: dbError } = await adminSupabase
                                .from('projects')
                                .update({
                                    title: currentProject.title,
                                    category: currentProject.category,
                                    description: currentProject.description,
                                    count: currentProject.count || 1,
                                    thumbnail_url: currentProject.thumbnail_url || null,
                                    updated_at: currentProject.updated_at
                                })
                                .eq('key', currentProject.key)
                                .select()
                                .single();
                            if (dbError) {
                                console.warn('âš ï¸ Database update failed:', dbError.message);
                            } else {
                                console.log('âœ… Project updated in database:', dbData);
                            }
                        }
                    } catch (dbError) {
                        console.error('âŒ Database operation failed:', dbError);
                    }
                }
                // Update in Supabase metadata bucket if available
                if (adminSupabase && SUPABASE_CONFIG.metadataBucket) {
                    const metadataFileName = `projects/${currentProject.key}.json`;
                    const { error } = await adminSupabase.storage
                        .from(SUPABASE_CONFIG.metadataBucket)
                        .upload(metadataFileName, JSON.stringify(currentProject, null, 2), {
                            contentType: 'application/json',
                            upsert: true
                        });
                    if (error) {
                        console.error('âŒ Metadata update failed:', error);
                    } else {
                        console.log('âœ… Updated metadata bucket');
                    }
                }
                // IMPORTANT: Also save project.json in the main portfolio bucket for portfolio page
                if (adminSupabase && SUPABASE_CONFIG.bucket) {
                    const projectJsonPath = `${currentProject.key}/project.json`;
                    const { error: projectJsonError } = await adminSupabase.storage
                        .from(SUPABASE_CONFIG.bucket)
                        .upload(projectJsonPath, JSON.stringify(currentProject, null, 2), {
                            contentType: 'application/json',
                            upsert: true,
                            cacheControl: '0'
                        });
                    if (projectJsonError) {
                        console.error('âŒ Failed to save project.json in portfolio bucket:', projectJsonError);
                    } else {
                        console.log('âœ… Saved project.json in portfolio bucket for portfolio page');
                    }
                }
                // Update button to saved state
                updateSaveButton('saved');
                if (isNewProject) {
                    showNotification('Project created successfully!', 'success');
                    // Only redirect if shouldRedirect is true (manual save, not auto-save before upload)
                    if (shouldRedirect) {
                        setTimeout(() => {
                            window.location.href = `project-manager.html?id=${currentProject.id}`;
                        }, 1500);
                    }
                } else {
                    showNotification('Project saved successfully!', 'success');
                }
                return true;
            } catch (error) {
                console.error('âŒ Save error:', error);
                // Update button to error state
                updateSaveButton('error');
                showNotification('Save failed: ' + error.message, 'error');
                return false;
            }
        }
        // Silent save for auto-save functionality (doesn't show full button animation)
        async function saveProjectSilently() {
            if (!currentProject) return;
            // Update project data
            currentProject.title = document.getElementById('projectTitle').value;
            currentProject.key = document.getElementById('projectKey').value;
            currentProject.category = document.getElementById('projectCategory').value;
            currentProject.description = document.getElementById('projectDescription').value;
            currentProject.tags = document.getElementById('projectTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            currentProject.count = parseInt(document.getElementById('projectCount').value) || 0;
            currentProject.updated_at = new Date().toISOString();
            console.log('ðŸ’¾ Silent saving project...');
            try {
                // Update in localStorage
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const projectIndex = projects.findIndex(p => p.id === currentProject.id);
                if (projectIndex !== -1) {
                    projects[projectIndex] = currentProject;
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
                // Update in Supabase database table
                if (adminSupabase) {
                    try {
                        const { data: dbData, error: dbError } = await adminSupabase
                            .from('projects')
                            .update({
                                title: currentProject.title,
                                category: currentProject.category,
                                description: currentProject.description,
                                count: currentProject.count || 1,
                                thumbnail_url: currentProject.thumbnail_url || null,
                                updated_at: currentProject.updated_at
                            })
                            .eq('key', currentProject.key)
                            .select()
                            .single();
                        if (dbError) {
                            // If update fails, try insert (project might not exist in DB)
                            await adminSupabase
                                .from('projects')
                                .insert([{
                                    title: currentProject.title,
                                    key: currentProject.key,
                                    category: currentProject.category,
                                    description: currentProject.description,
                                    count: currentProject.count || 1,
                                    thumbnail_url: currentProject.thumbnail_url || null,
                                    created_at: currentProject.created_at || currentProject.updated_at,
                                    updated_at: currentProject.updated_at
                                }]);
                        }
                    } catch (dbError) {
                        console.error('âŒ Silent save database error:', dbError);
                    }
                }
                // Update in Supabase metadata bucket if available
                if (adminSupabase && SUPABASE_CONFIG.metadataBucket) {
                    const metadataFileName = `projects/${currentProject.key}.json`;
                    await adminSupabase.storage
                        .from(SUPABASE_CONFIG.metadataBucket)
                        .upload(metadataFileName, JSON.stringify(currentProject, null, 2), {
                            contentType: 'application/json',
                            upsert: true
                        });
                }
                // IMPORTANT: Also save project.json in the main portfolio bucket for portfolio page
                if (adminSupabase && SUPABASE_CONFIG.bucket) {
                    const projectJsonPath = `${currentProject.key}/project.json`;
                    await adminSupabase.storage
                        .from(SUPABASE_CONFIG.bucket)
                        .upload(projectJsonPath, JSON.stringify(currentProject, null, 2), {
                            contentType: 'application/json',
                            upsert: true,
                            cacheControl: '0'
                        });
                }
                // Reset button to normal state for auto-save
                updateSaveButton('normal');
                console.log('âœ… Silent save completed');
            } catch (error) {
                console.error('âŒ Silent save error:', error);
                updateSaveButton('normal');
            }
        }
        async function deleteProject() {
            if (!confirm(`Are you sure you want to delete "${currentProject.title}"? This action cannot be undone.`)) return;
            try {
                // Delete project files
                if (adminSupabase && projectFiles.length > 0) {
                    const filePaths = projectFiles.map(f => f.path);
                    const { error } = await adminSupabase.storage
                        .from(SUPABASE_CONFIG.bucket)
                        .remove(filePaths);
                    if (error) {
                        console.error('âŒ Error deleting files:', error);
                    }
                }
                // Delete from localStorage
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                const updatedProjects = projects.filter(p => p.id !== currentProject.id);
                localStorage.setItem('projects', JSON.stringify(updatedProjects));
                // Delete from metadata bucket
                if (adminSupabase && SUPABASE_CONFIG.metadataBucket) {
                    const metadataFileName = `projects/${currentProject.key}.json`;
                    await adminSupabase.storage
                        .from(SUPABASE_CONFIG.metadataBucket)
                        .remove([metadataFileName]);
                }
                showNotification('Project deleted successfully!', 'success');
                // Redirect back to admin
                setTimeout(() => {
                    window.location.href = '4dm1n.html';
                }, 2000);
            } catch (error) {
                console.error('âŒ Delete error:', error);
                showNotification('Delete failed: ' + error.message, 'error');
            }
        }
        function goBack() {
            window.location.href = '4dm1n.html';
        }
    </script>
</body>
</html>
</content>
</invoke>

