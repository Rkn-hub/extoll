<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Sync Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0284c7; }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .project-card {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <h1>üîÑ Portfolio Sync Test</h1>
    
    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="testAll()">üß™ Run All Tests</button>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="forceSync()">üîÑ Force Sync Portfolio</button>
    </div>
    
    <div class="grid">
        <div class="section">
            <h2>üì¶ LocalStorage Projects</h2>
            <button onclick="checkLocalStorage()">Check LocalStorage</button>
            <div id="localStorageProjects"></div>
        </div>
        
        <div class="section">
            <h2>‚òÅÔ∏è Supabase Projects</h2>
            <button onclick="checkSupabase()">Check Supabase</button>
            <div id="supabaseProjects"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>üéØ Portfolio Display Test</h2>
        <button onclick="testPortfolioDisplay()">Test Portfolio Display</button>
        <div id="portfolioTest"></div>
    </div>
    
    <div class="section">
        <h2>Test Log</h2>
        <div id="log" class="log">Ready to test portfolio sync...\n</div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        let testSupabase = null;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
        }
        
        async function testAll() {
            log('üöÄ Starting comprehensive sync test...');
            await checkLocalStorage();
            await checkSupabase();
            await testPortfolioDisplay();
            await compareData();
            log('‚úÖ All tests completed!', 'success');
        }
        
        function checkLocalStorage() {
            try {
                log('üì¶ Checking localStorage projects...');
                
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                log(`Found ${projects.length} projects in localStorage`);
                
                const container = document.getElementById('localStorageProjects');
                
                if (projects.length === 0) {
                    container.innerHTML = '<p>No projects in localStorage</p>';
                    log('‚ùå No projects found in localStorage', 'warning');
                    return;
                }
                
                container.innerHTML = projects.map((project, index) => `
                    <div class="project-card">
                        <strong>${project.title}</strong><br>
                        <small>Key: ${project.key}</small><br>
                        <small>Category: ${project.category}</small><br>
                        <small>Created: ${new Date(project.created_at).toLocaleString()}</small><br>
                        <small>Thumbnail: ${project.thumbnail_url ? '‚úÖ Yes' : '‚ùå No'}</small>
                    </div>
                `).join('');
                
                projects.forEach((project, index) => {
                    log(`  ${index + 1}. ${project.title} (${project.key}) - ${project.category}`);
                });
                
                log('‚úÖ LocalStorage check completed', 'success');
                
            } catch (error) {
                log(`‚ùå LocalStorage check failed: ${error.message}`, 'error');
            }
        }
        
        async function checkSupabase() {
            try {
                log('‚òÅÔ∏è Checking Supabase projects...');
                
                // Initialize Supabase
                if (!testSupabase) {
                    if (initializeSupabase()) {
                        testSupabase = configSupabase;
                        log('‚úÖ Supabase initialized');
                    } else {
                        throw new Error('Failed to initialize Supabase');
                    }
                }
                
                // Get projects from Supabase
                const result = await getProjects();
                
                const container = document.getElementById('supabaseProjects');
                
                if (!result.success) {
                    container.innerHTML = `<p class="error">Error: ${result.error}</p>`;
                    log(`‚ùå Supabase error: ${result.error}`, 'error');
                    return;
                }
                
                const projects = result.data;
                log(`Found ${projects.length} projects in Supabase metadata bucket`);
                
                if (projects.length === 0) {
                    container.innerHTML = '<p>No projects in Supabase</p>';
                    log('‚ùå No projects found in Supabase', 'warning');
                    return;
                }
                
                container.innerHTML = projects.map((project, index) => `
                    <div class="project-card">
                        <strong>${project.title}</strong><br>
                        <small>Key: ${project.key}</small><br>
                        <small>Category: ${project.category}</small><br>
                        <small>Created: ${new Date(project.created_at).toLocaleString()}</small><br>
                        <small>Thumbnail: ${project.thumbnail_url ? '‚úÖ Yes' : '‚ùå No'}</small>
                    </div>
                `).join('');
                
                projects.forEach((project, index) => {
                    log(`  ${index + 1}. ${project.title} (${project.key}) - ${project.category}`);
                });
                
                log('‚úÖ Supabase check completed', 'success');
                
            } catch (error) {
                log(`‚ùå Supabase check failed: ${error.message}`, 'error');
            }
        }
        
        async function testPortfolioDisplay() {
            try {
                log('üéØ Testing portfolio display logic...');
                
                // Simulate the portfolio loading logic
                let projects = [];
                
                // Try Supabase first
                if (!testSupabase) {
                    if (initializeSupabase()) {
                        testSupabase = configSupabase;
                    }
                }
                
                if (testSupabase) {
                    const result = await getProjects();
                    if (result.success && result.data.length > 0) {
                        projects = result.data;
                        log(`‚úÖ Portfolio would load ${projects.length} projects from Supabase`, 'success');
                    } else {
                        log('‚ö†Ô∏è Supabase failed, falling back to localStorage', 'warning');
                        projects = JSON.parse(localStorage.getItem('projects') || '[]');
                        log(`üì¶ Portfolio would load ${projects.length} projects from localStorage`);
                    }
                } else {
                    projects = JSON.parse(localStorage.getItem('projects') || '[]');
                    log(`üì¶ Portfolio would load ${projects.length} projects from localStorage (no Supabase)`);
                }
                
                const container = document.getElementById('portfolioTest');
                
                if (projects.length === 0) {
                    container.innerHTML = '<p class="warning">Portfolio would show empty state</p>';
                    log('‚ùå Portfolio would be empty!', 'error');
                    return;
                }
                
                // Test project card creation
                container.innerHTML = `
                    <h3>Portfolio would show ${projects.length} projects:</h3>
                    ${projects.map(project => `
                        <div class="project-card">
                            <strong>${project.title}</strong> (${project.category})<br>
                            <small>Thumbnail: ${project.thumbnail_url ? 'Has thumbnail' : 'No thumbnail - would show placeholder'}</small>
                        </div>
                    `).join('')}
                `;
                
                log('‚úÖ Portfolio display test completed', 'success');
                
            } catch (error) {
                log(`‚ùå Portfolio display test failed: ${error.message}`, 'error');
            }
        }
        
        async function compareData() {
            try {
                log('üîç Comparing localStorage vs Supabase data...');
                
                const localProjects = JSON.parse(localStorage.getItem('projects') || '[]');
                
                let supabaseProjects = [];
                if (testSupabase) {
                    const result = await getProjects();
                    if (result.success) {
                        supabaseProjects = result.data;
                    }
                }
                
                log(`LocalStorage: ${localProjects.length} projects`);
                log(`Supabase: ${supabaseProjects.length} projects`);
                
                if (localProjects.length !== supabaseProjects.length) {
                    log('‚ö†Ô∏è Project count mismatch!', 'warning');
                    log('This could explain why updates are not reflecting', 'warning');
                }
                
                // Check for missing projects
                const localKeys = localProjects.map(p => p.key);
                const supabaseKeys = supabaseProjects.map(p => p.key);
                
                const missingInSupabase = localKeys.filter(key => !supabaseKeys.includes(key));
                const missingInLocal = supabaseKeys.filter(key => !localKeys.includes(key));
                
                if (missingInSupabase.length > 0) {
                    log(`‚ùå Missing in Supabase: ${missingInSupabase.join(', ')}`, 'error');
                }
                
                if (missingInLocal.length > 0) {
                    log(`‚ùå Missing in localStorage: ${missingInLocal.join(', ')}`, 'error');
                }
                
                if (missingInSupabase.length === 0 && missingInLocal.length === 0) {
                    log('‚úÖ All projects exist in both storage systems', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Data comparison failed: ${error.message}`, 'error');
            }
        }
        
        async function forceSync() {
            try {
                log('üîÑ Force syncing portfolio...');
                
                // Clear localStorage
                localStorage.removeItem('projects');
                log('üóëÔ∏è Cleared localStorage projects');
                
                // Reload from Supabase
                if (!testSupabase) {
                    if (initializeSupabase()) {
                        testSupabase = configSupabase;
                    }
                }
                
                if (testSupabase) {
                    const result = await getProjects();
                    if (result.success) {
                        // Store in localStorage
                        localStorage.setItem('projects', JSON.stringify(result.data));
                        log(`‚úÖ Synced ${result.data.length} projects from Supabase to localStorage`, 'success');
                        
                        // Refresh displays
                        await checkLocalStorage();
                        await testPortfolioDisplay();
                    } else {
                        log(`‚ùå Failed to sync: ${result.error}`, 'error');
                    }
                } else {
                    log('‚ùå Cannot sync: Supabase not available', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Force sync failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            log('üöÄ Portfolio sync test loaded');
            log('üëÜ Click "Run All Tests" to diagnose sync issues');
        });
    </script>
</body>
</html>