<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Troubleshoot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0284c7; }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        input {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 5px;
            width: 300px;
            margin: 5px;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîê Authentication Troubleshoot</h1>
    
    <div class="section">
        <h2>Current Configuration</h2>
        <div id="currentConfig"></div>
    </div>
    
    <div class="section">
        <h2>Test Different Credentials</h2>
        <label>Email:</label>
        <input type="email" id="testEmail" placeholder="Enter email to test">
        
        <label>Password:</label>
        <input type="password" id="testPassword" placeholder="Enter password to test">
        
        <br><br>
        <button onclick="testCredentials()">üß™ Test These Credentials</button>
    </div>
    
    <div class="section">
        <h2>Check Supabase Users</h2>
        <button onclick="listUsers()">üë• List All Users (if possible)</button>
        <p><em>Note: This might not work due to RLS policies, but worth trying</em></p>
    </div>
    
    <div class="section">
        <h2>Test Log</h2>
        <div id="log" class="log">Ready to test authentication...\n</div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        let testSupabase = null;
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
        }
        
        function showCurrentConfig() {
            const configDiv = document.getElementById('currentConfig');
            if (typeof SUPABASE_CONFIG !== 'undefined') {
                configDiv.innerHTML = `
                    <p><strong>Current Email:</strong> ${SUPABASE_CONFIG.adminEmail}</p>
                    <p><strong>Current Password:</strong> ${SUPABASE_CONFIG.adminPassword}</p>
                    <p><strong>Supabase URL:</strong> ${SUPABASE_CONFIG.url}</p>
                    <p><strong>Project:</strong> ${SUPABASE_CONFIG.url.split('//')[1].split('.')[0]}</p>
                `;
            } else {
                configDiv.innerHTML = '<p class="error">‚ùå Configuration not loaded</p>';
            }
        }
        
        async function testCredentials() {
            const email = document.getElementById('testEmail').value.trim();
            const password = document.getElementById('testPassword').value.trim();
            
            if (!email || !password) {
                log('‚ùå Please enter both email and password', 'error');
                return;
            }
            
            try {
                log(`üîê Testing credentials: ${email}`);
                
                if (!testSupabase) {
                    testSupabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                }
                
                // First, sign out any existing session
                await testSupabase.auth.signOut();
                log('üö™ Signed out existing session');
                
                // Try to sign in with provided credentials
                const { data, error } = await testSupabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    log(`‚ùå Authentication failed: ${error.message}`, 'error');
                    
                    if (error.message.includes('Invalid login credentials')) {
                        log('üí° This means the email/password combination is not found in Supabase', 'warning');
                        log('üí° Check: Authentication ‚Üí Users in Supabase Dashboard', 'warning');
                    } else if (error.message.includes('Email not confirmed')) {
                        log('üí° Email needs to be confirmed. Check user details in Supabase Dashboard', 'warning');
                    } else if (error.message.includes('Too many requests')) {
                        log('üí° Rate limited. Wait a few minutes and try again', 'warning');
                    }
                    return;
                }
                
                if (!data.user) {
                    log('‚ùå No user data returned', 'error');
                    return;
                }
                
                log('‚úÖ Authentication successful!', 'success');
                log(`üë§ User ID: ${data.user.id}`, 'success');
                log(`üìß Email: ${data.user.email}`, 'success');
                log(`‚úâÔ∏è Email confirmed: ${data.user.email_confirmed_at ? 'Yes' : 'No'}`, 'success');
                log(`üïí Created: ${new Date(data.user.created_at).toLocaleString()}`, 'success');
                log(`üïí Last sign in: ${data.user.last_sign_in_at ? new Date(data.user.last_sign_in_at).toLocaleString() : 'Never'}`, 'success');
                
                // Test metadata bucket access with these credentials
                log('üß™ Testing metadata bucket access with these credentials...');
                
                const { data: bucketData, error: bucketError } = await testSupabase.storage
                    .from(SUPABASE_CONFIG.metadataBucket)
                    .list('projects', { limit: 1 });
                
                if (bucketError) {
                    log(`‚ùå Metadata bucket access failed: ${bucketError.message}`, 'error');
                } else {
                    log('‚úÖ Metadata bucket access successful!', 'success');
                    log(`üìÅ Found ${bucketData.length} files in projects folder`, 'success');
                }
                
                log('üéØ These credentials work! Update your config with these values.', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        async function listUsers() {
            try {
                log('üë• Attempting to list users...');
                
                if (!testSupabase) {
                    testSupabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                }
                
                // This will likely fail due to RLS, but worth trying
                const { data, error } = await testSupabase.auth.admin.listUsers();
                
                if (error) {
                    log(`‚ùå Cannot list users: ${error.message}`, 'error');
                    log('üí° This is normal - you need to check users in Supabase Dashboard', 'warning');
                    log('üí° Go to: Authentication ‚Üí Users to see all created users', 'warning');
                } else {
                    log(`‚úÖ Found ${data.users.length} users:`, 'success');
                    data.users.forEach(user => {
                        log(`   üìß ${user.email} (${user.email_confirmed_at ? 'Confirmed' : 'Unconfirmed'})`, 'success');
                    });
                }
                
            } catch (error) {
                log(`‚ùå List users failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            showCurrentConfig();
            log('üöÄ Authentication troubleshoot loaded');
            log('üëÜ Enter your new credentials above and test them');
        });
    </script>
</body>
</html>